# ジョブ実行対象サーバ除外ツール - 技術詳細・カスタマイズ方法

## 1. BATファイルのカスタマイズ

BATファイル（`run_filter-UTF8noBOM.bat`）を編集することで、以下の設定を変更できます。

### 1.1 文字コード設定

```bat
set ENCODING=UTF8NoBOM
```

**設定可能な値:**
- `UTF8NoBOM`: UTF-8（BOMなし）- デフォルト
- `UTF8BOM`: UTF-8（BOMあり）
- `Shift_JIS` または `SJIS`: Shift_JIS

### 1.2 対象拡張子（ホワイトリスト）

```bat
set TARGET_EXTS=".csv", ".conf", ".xml", ".properties", ".txt"
```

処理を許可する拡張子を指定します。これ以外の拡張子（.exe, .zip, .xlsx 等）は無視されます。

### 1.3 除外パターン（ブラックリスト）

```bat
set EXCLUDE_PATTERN="*_backup.*", "master_*", "*.old"
```

処理から除外するファイル名のパターンを指定します。ワイルドカード（`*`）が使用できます。

### 1.4 除外リストファイル名

```bat
set DELETE_LIST_FILE=delete_servers.txt
```

除外対象サーバ名を記載したテキストファイル名を指定します。このファイルは、PS1スクリプトと同じフォルダに配置する必要があります。

### 1.5 ログファイルの保持設定

```bat
set KEEP_LOG_ON_SUCCESS=1
```

正常終了時のログファイルの動作を制御します。

**設定可能な値:**
- `1`（デフォルト）: 正常終了時でもログファイルを保持します
- `0`: 正常終了時はログファイルを削除します

**注意事項:**
- 警告（既存ファイルのスキップなど）やエラーが発生した場合、設定に関係なくログファイルは保持されます
- ログファイル名は `filter_file_YYYYMMDD_HHMMSS.log` 形式で、実行日時（秒単位）が含まれます
- ログファイルは、BATファイルと同じフォルダに作成されます

## 2. ログファイルについて

### 2.1 ログファイルの作成

実行時に、`filter_file_YYYYMMDD_HHMMSS.log`という名前のログファイルが作成されます。

- **場所**: BATファイルと同じフォルダ
- **形式**: `filter_file_YYYYMMDD_HHMMSS.log`（YYYYMMDD: 日付、HHMMSS: 時刻）

### 2.2 ログファイルの内容

ログファイルには以下の情報が記録されます：

- エンコーディング設定
- 対象拡張子
- 除外パターン
- 除外リスト（サーバ名）
- 処理対象ファイル数とファイルパス
- 各ファイルの処理結果（成功/失敗、除外行数）
- 警告メッセージ（スキップされたファイルなど）
- エラーメッセージ（エラーが発生した場合）

### 2.3 ログファイルの保持/削除

- **正常終了時**: `KEEP_LOG_ON_SUCCESS`設定に従います（デフォルト: 保持）
- **警告発生時**: 設定に関係なく保持されます
- **エラー発生時**: 設定に関係なく保持されます

## 3. FAQ

### Q1: ログファイルが作成されない

**A:** 以下の可能性があります：
- PowerShellスクリプトの出力がリダイレクトされていない
- ログファイルのパスが正しく設定されていない
- ファイルシステムの権限の問題

### Q2: 正常終了時にログファイルを削除したい

**A:** BATファイル内の`KEEP_LOG_ON_SUCCESS`を`0`に設定してください。

### Q3: 複数のファイルを一度に処理できるか

**A:** はい。複数のファイルをBATファイルにドロップすることで、一度に処理できます。

### Q4: 元ファイルは変更されるか

**A:** いいえ。元ファイルは一切変更されません。処理結果は`output`フォルダ内に新しいファイルとして作成されます。

## 4. トラブルシューティング

### 4.1 エラーメッセージの確認

エラーが発生した場合、ログファイルに詳細な情報が記録されます。ログファイルを確認してください。

### 4.2 デバッグモード

BATファイル内の`[DEBUG]`メッセージが表示されている場合、デバッグ情報が出力されています。通常の運用では、これらのメッセージは削除しても問題ありません。
